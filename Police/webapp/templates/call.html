{% extends "base.html" %}
{% block title %}–°–º–µ–Ω–∞{% endblock %}
{% block style %}prepare.css{% endblock %}
{% block content %}
<body data-path-to-root="./" data-include-products="false" class="u-body u-xl-mode" data-lang="ru">
  <header class="u-clearfix u-header u-sticky" id="sec-74aa" data-animation-name="" data-animation-duration="0" data-animation-delay="0" data-animation-direction="">
    <div class="u-container-style u-expanded-width u-group u-shape-rectangle u-white u-group-1">
      <div class="u-container-layout u-container-layout-1">
        <p class="u-text u-text-default u-text-1"> –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, {{ name }}. –í–∞—à–∞ —Å–º–µ–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å: {{ date }}</p>
        <p class="u-text u-text-default u-text-2" style="margin-right: 250px;"> –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: <span id="timenow">{{ date }}</span></p>
        <p class="u-text u-text-default u-text-2" style="margin-right: 100px;"> –°—á—ë—Ç: <span id="score">{{ score }}</span></p>
      </div>
    </div>
  </header>
    <!-- /////////// -->

    <section class="u-clearfix u-valign-top u-section-1" id="sec-125d">
      <div class="u-container-style u-shape-rectangle u-group-4" style="min-height: 0; margin-left: 48%;" id="loading">
        <img class="custom-expanded u-image u-image-default u-image-3" src="/static/images/loading-96.gif" alt="–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤" style="margin-left: 40px;">
        <h4 class="u-custom-font u-font-open-sans u-text u-text-grey-40 u-text-13" id="description"> –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ <br></h4>
      </div>
    </section>

    
    <!-- /////////// -->
    <section class="u-clearfix u-section-2" id="sec-a23d">
      <div class="u-clearfix u-sheet u-sheet-1"></div>
    </section>
    
    
    
    
    <section class="u-backlink u-clearfix u-grey-80">
      <p class="u-text">
        <span>–ú–æ–¥–µ–ª—å –ø–æ–ª–∏—Ü–∏–∏. </span>
        <a class="u-link" href="/index" target="_blank" rel="nofollow">
          <span>–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
        </a>
      </p>
    </section>

  <script>
    var checkboxes = document.querySelectorAll('#patrol_table input[type="checkbox"]');
    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            var checkboxId = this.getAttribute('name');
            var row = document.getElementById(checkboxId);
            if (checkbox.checked) {
                row.style.display = 'none';
                row.querySelector('input[type="checkbox"]').checked = false;
            } else {
                row.style.display = '';
            }
        });
    });
  </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.1/socket.io.js"></script>
<script>
    var socket = io();

    var eventContent = `
    <div class="u-container-style u-group u-shape-rectangle u-group-4">
      <div class="u-container-layout u-container-layout-4">
        <img class="u-image u-image-default u-image-3" src="static/images/background.png" alt="" data-image-width="400" data-image-height="265" id="event_img">
        <h1 class="u-custom-font u-font-open-sans u-text u-text-font u-text-11" id="event_type">
            event.type
        </h1>
        <h4 class="u-custom-font u-font-open-sans u-text u-text-grey-40 u-text-12">
          <span style="font-weight: 600;" class="u-text-palette-1-base" id="title"> event.title </span>
          <br>
        </h4>
        <h4 class="u-custom-font u-font-open-sans u-text u-text-grey-40 u-text-13" id="description"> event.description <br>
        </h4>
        <h4 class="u-custom-font u-font-open-sans u-text u-text-grey-40 u-text-13" id="address"> event.address <br>
        </h4>
        <h4 class="u-text u-text-grey-40 u-text-14">‚Üì ‚Äã‚Äã–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å <span class="u-text-palette-2-base"><span id="slots">event.slots</span> –æ—Ñ–∏—Ü–µ—Ä–æ–≤</span>.
        </h4>
        <div class="u-table u-table-responsive u-table-1" id="table_div">
          <table class="u-table-entity" id="table">
            <colgroup>
              <col width="4.2%">
              <col width="5.3%">
              <col width="16%">
              <col width="30.9%">
              <col width="13.1%">
              <col width="7.2%">
              <col width="23.399999999999995%">
            </colgroup>
            <thead class="u-table-header">
              <tr style="height: 69px;">
                <th class="u-border-1 u-border-grey-25 u-table-cell u-text-grey-30"></th>
                <th class="u-border-1 u-border-grey-25 u-table-cell u-text-grey-30"> ‚Ññ</th>
                <th class="u-border-1 u-border-grey-25 u-table-cell u-text-grey-30"> –¢–∏–ø –æ—Ñ–∏—Ü–µ—Ä–∞</th>
                <th class="u-border-1 u-border-grey-25 u-table-cell u-text-grey-30"> –ò–º—è</th>
                <th class="u-border-1 u-border-grey-25 u-table-cell u-text-grey-30"> –ó–≤–∞–Ω–∏–µ</th>
                <th class="u-border-1 u-border-grey-25 u-table-cell u-text-grey-30"> –û–ø—ã—Ç</th>
                <th class="u-border-1 u-border-grey-25 u-table-cell u-text-grey-30"> –ë—É–¥–µ—Ç —Å–≤–æ–±–æ–¥–µ–Ω</th>
              </tr>
            </thead>
            <tbody class="u-table-body" id="patrol_table">


            </tbody>
          </table>
          <span style="font-weight: 600; display: none;" id="sended" >–û—Ñ–∏—Ü–µ—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.</span>
        </div>
      </div>
    </div>
    <!-- <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <!-- <input class="u-border-none u-btn u-btn-round u-button-style u-grey-10 u-hover-palette-1-base u-radius u-btn-1" id="submit" name="submit" required="" type="submit" value="–ù–∞–∑–Ω–∞—á–∏—Ç—å"> -->
    `;

    var callSection = document.getElementById('sec-125d');

    socket.on('message_from_server', function(message) {
      console.log(message);

      var loading = document.getElementById('loading');
      loading.style.display = "none";
      loading.id = "";
      

      

      var tempDiv = document.createElement('div');
      // var randomId = 'event_' + Math.random().toString(36).substr(2, 9); // –ø—Ä–∏–º–µ—Ä: event_g8x1l2m3h
      // tempDiv.id = randomId;
      tempDiv.innerHTML = eventContent;
      
      var parsedMessage = JSON.parse(message);

      var parsedDuty = parsedMessage.duty;
      if (parsedDuty === 'off') {
          window.location.href = '/result';
      }

      var parsedTimenow = parsedMessage.timenow;
      var parsedEvent = parsedMessage.event;
      var parsedOfficers = parsedMessage.officers;

      var timenow = document.getElementById('timenow');
      timenow.innerHTML = parsedTimenow;

      if (parsedEvent.type == 'call') {
        tempDiv.querySelector('#event_type').innerHTML = '–í—ã–∑–æ–≤!';
        tempDiv.querySelector('#event_img').src = "static/images/police-officer_1f46e.png";
        tempDiv.querySelector('#address').innerHTML = parsedEvent.address;
      } else {
        tempDiv.querySelector('#event_type').innerHTML = '–°–æ–≤–µ—Ä—à–µ–Ω–æ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ!';
        tempDiv.querySelector('#event_img').src = "static/images/detective_1f575-fe0f.png";
        tempDiv.querySelector('#address').innerHTML = '';
      }
      tempDiv.querySelector('#title').innerHTML = parsedEvent.title;
      tempDiv.querySelector('#description').innerHTML = parsedEvent.description;
      tempDiv.querySelector('#slots').innerHTML = parsedEvent.slots;

      callSection.innerHTML += tempDiv.innerHTML;
      callSection.innerHTML += `
      <input class="u-border-none u-btn u-btn-round u-button-style u-grey-10 u-hover-palette-1-base u-radius u-btn-1" id="submit" name="submit" required="" type="submit" value="–ù–∞–∑–Ω–∞—á–∏—Ç—å">
      `;
      
      var emoji = 'üïµÔ∏èDetective';
      if (parsedEvent.type == 'call') {
        emoji = 'üëÆPatrol Officer';
      }
      parsedOfficers.forEach(function(officer, index) {
        var decoration = '';
        var checkbox = `<input type="checkbox" id="myCheckbox" name="${officer.name}" value="">`;
        if (officer.status == 'unavailable') {
          decoration = ' text-decoration: line-through;';
          checkbox = ''
        }
        // <tr style="height: 45px; text-decoration: line-through;">
        var officerContent = `
        <tr style="height: 45px;${decoration}" id="officer_row">
          <td class="u-border-1 u-border-grey-25 u-table-cell">
              ${checkbox}
          </td>
          <td class="u-border-1 u-border-grey-25 u-table-cell">${index+1}</td>
          <td class="u-border-1 u-border-grey-25 u-table-cell">${emoji}</td>
          <td class="u-border-1 u-border-grey-25 u-table-cell">${officer.name}</td>
          <td class="u-border-1 u-border-grey-25 u-table-cell">${officer.rank}</td>
          <td class="u-border-1 u-border-grey-25 u-table-cell">‚òÖ ${officer.experience}</td>
          <td class="u-border-1 u-border-grey-25 u-table-cell">${officer.unavailable_until}</td>
        </tr>
      `;
        // var tempDivOfficer = document.createElement('div');
        // tempDivOfficer.innerHTML = officerContent;
        var patrolTable = document.querySelector('#patrol_table');
        patrolTable.innerHTML += officerContent;
      });

      var checkboxes = document.querySelectorAll('#patrol_table input[type="checkbox"]');
      
      checkboxes.forEach(function(checkbox) {
          checkbox.addEventListener('change', function() {
              var checkedCheckboxes = document.querySelectorAll('#patrol_table input[type="checkbox"]:checked');
              if (checkedCheckboxes.length > parsedEvent.slots) {
                this.checked = false;
              }
          });
      });

      document.getElementById('submit').addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('#table input[type="checkbox"]:checked');
        var selectedNames = [];
        checkboxes.forEach(function(checkbox) {
          selectedNames.push(checkbox.name);
        });

        var jsonNames = JSON.stringify(selectedNames);

        var table_div = document.getElementById('table_div');
        var table = document.getElementById('table');
        if (table && table_div) {
          table_div.removeChild(table);
          table_div.id = '';
        }
        
        var submit = document.getElementById('submit');
        if (submit && callSection) {
            callSection.removeChild(submit);
        }
        
        var sended = document.getElementById('sended');
        if (selectedNames.length == 0) {
          sended.innerHTML = '–í—ã–∑–æ–≤ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω.';
        }
        sended.style.display = "";
        sended.id = "";


        callSection.innerHTML += `
          <div class="u-container-style u-shape-rectangle u-group-4" style="min-height: 0; margin-left: 48%;" id="loading">
            <img class="custom-expanded u-image u-image-default u-image-3" src="/static/images/loading-96.gif" alt="–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤" style="margin-left: 40px;">
            <h4 class="u-custom-font u-font-open-sans u-text u-text-grey-40 u-text-13" id="description"> –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ <br></h4>
          </div>
        `;

        socket.emit('message_from_client', jsonNames);
        
      });
      // callSection.querySelector('#title').innerHTML = message;
      // document.getElementById('content').innerHTML += message;
    });

    socket.on('score', function(message) {
      var parsedMessage = JSON.parse(message);
      console.log(parsedMessage);

      var score = document.getElementById('score');
      score.innerHTML = parsedMessage.score.value;
      
      if (parsedMessage.score.type == 'penalty') {
        alert("–í—ã–∑–æ–≤ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω!\n-10 –æ—Ç —Å—á—ë—Ç–∞");
      }
    });
</script>

</body>
{% endblock %}